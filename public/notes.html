<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Notes — Student Academic Hub</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
  <div class="container">
    <a class="navbar-brand" href="dashboard.html"><i class="fas fa-graduation-cap me-2"></i>AcademicHub</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" data-page="dashboard" href="dashboard.html"><i class="fas fa-th-large me-1"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" data-page="notes"    href="notes.html"><i class="fas fa-sticky-note me-1"></i>Notes</a></li>
        <li class="nav-item"><a class="nav-link" data-page="projects" href="projects.html"><i class="fas fa-project-diagram me-1"></i>Projects</a></li>
        <li class="nav-item"><a class="nav-link" data-page="deadlines" href="deadlines.html"><i class="fas fa-clock me-1"></i>Deadlines</a></li>
        <li class="nav-item"><a class="nav-link" data-page="groups"  href="groups.html"><i class="fas fa-users me-1"></i>Groups</a></li>
      </ul>
      <div class="d-flex align-items-center gap-3">
        <span class="text-light" id="studentName"></span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()"><i class="fas fa-sign-out-alt me-1"></i>Logout</button>
      </div>
    </div>
  </div>
</nav>

<div class="container py-4">
  <!-- Header -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
    <h4 class="page-title mb-0"><i class="fas fa-sticky-note me-2"></i>My Notes</h4>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#noteModal" onclick="openAdd()">
      <i class="fas fa-plus me-1"></i>Add Note
    </button>
  </div>

  <!-- Search + Filter -->
  <div class="d-flex flex-wrap gap-2 mb-4">
    <input type="text" id="searchInput" class="search-input" placeholder="Search notes..." style="max-width:260px;" oninput="renderNotes()" />
    <input type="text" id="subjectFilter" class="search-input" placeholder="Filter by subject..." style="max-width:200px;" oninput="renderNotes()" />
    <div class="filter-tabs d-flex gap-1">
      <button class="btn btn-outline-secondary btn-sm active" id="filterAll"    onclick="setFilter('all')">All</button>
      <button class="btn btn-outline-secondary btn-sm"         id="filterShared" onclick="setFilter('shared')">Shared</button>
    </div>
  </div>

  <!-- Notes Grid -->
  <div class="row g-3" id="notesGrid">
    <div class="col-12"><div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></div></div>
  </div>
</div>

<!-- Add/Edit Modal -->
<div class="modal fade" id="noteModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Add Note</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="noteId" />
        <div class="mb-3">
          <label>Title *</label>
          <input type="text" id="noteTitle" class="form-control mt-1" placeholder="Note title" required />
        </div>
        <div class="mb-3">
          <label>Subject</label>
          <input type="text" id="noteSubject" class="form-control mt-1" placeholder="e.g. Mathematics, Physics" />
        </div>
        <div class="mb-3">
          <label>Content</label>
          <textarea id="noteContent" class="form-control mt-1" rows="6" placeholder="Write your note here..."></textarea>
        </div>
        <div class="mb-3" id="noteAddFileSection">
          <label>Attachments <span style="color:var(--muted);font-size:.82rem;">(optional)</span></label>
          <label class="btn btn-outline-secondary btn-sm mt-1 d-block" style="cursor:pointer;text-align:left;">
            <i class="fas fa-paperclip me-1"></i>Choose files
            <input type="file" id="noteAddFileInput" multiple style="display:none;" onchange="updateNoteFilePreview()" />
          </label>
          <div id="noteAddFilePreview" style="margin-top:.4rem;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveNote()">
          <span id="saveSpinner" class="spinner-border spinner-border-sm me-1 d-none"></span>
          <span id="saveText">Save Note</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- View Note Modal -->
<div class="modal fade" id="viewModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="viewMeta" class="mb-3" style="color:var(--muted);font-size:.85rem;"></div>
        <div id="viewContent" style="white-space:pre-wrap;line-height:1.7;"></div>

        <!-- Attachments -->
        <div class="attachment-list">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <small style="color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.05em;">
              <i class="fas fa-paperclip me-1"></i>Attachments
            </small>
            <label class="btn btn-outline-secondary btn-sm py-0 px-2" style="cursor:pointer;">
              <i class="fas fa-upload me-1"></i>Upload
              <input type="file" id="noteFileInput" style="display:none;" onchange="uploadNoteFile()" />
            </label>
          </div>
          <div id="noteAttachmentsList"></div>
          <div id="noteUploadProgress" class="upload-progress d-none"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="openEditFromView()">
          <i class="fas fa-edit me-1"></i>Edit Note
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/utils.js"></script>
<script>
  if (!checkAuth()) throw new Error('Not logged in');
  initNav('notes');

  let allNotes        = [];
  let curFilter       = 'all';
  let currentViewNoteId = null;

  async function loadNotes() {
    try {
      allNotes = await api('GET', '/notes');
      renderNotes();
    } catch (err) { toast(err.message, 'error'); }
  }

  function setFilter(f) {
    curFilter = f;
    document.querySelectorAll('.filter-tabs .btn').forEach(b => b.classList.remove('active'));
    document.getElementById('filter' + f.charAt(0).toUpperCase() + f.slice(1)).classList.add('active');
    renderNotes();
  }

  function renderNotes() {
    const q   = document.getElementById('searchInput').value.toLowerCase();
    const sub = document.getElementById('subjectFilter').value.toLowerCase();
    let notes = allNotes.filter(n => {
      const matchQ   = n.title.toLowerCase().includes(q) || (n.content||'').toLowerCase().includes(q);
      const matchSub = !sub || (n.subject||'').toLowerCase().includes(sub);
      const matchF   = curFilter === 'all' || (curFilter === 'shared' && n.isShared);
      return matchQ && matchSub && matchF;
    });

    const grid = document.getElementById('notesGrid');
    if (!notes.length) {
      grid.innerHTML = `<div class="col-12"><div class="empty-state"><i class="fas fa-sticky-note"></i><p>No notes found</p><button class="btn btn-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#noteModal" onclick="openAdd()">Add your first note</button></div></div>`;
      return;
    }
    grid.innerHTML = notes.map(n => `
      <div class="col-sm-6 col-md-4">
        <div class="note-card">
          <div class="d-flex justify-content-between align-items-start mb-1">
            <div>
              ${n.subject ? `<span class="subject-tag">${esc(n.subject)}</span>` : ''}
            </div>
            ${n.isShared ? '<span class="shared-badge"><i class="fas fa-share-alt me-1"></i>Shared</span>' : ''}
          </div>
          <h6 class="fw-600 mb-1" style="cursor:pointer" onclick="viewNote('${n._id}')">${esc(n.title)}</h6>
          <p class="note-preview mb-2">${esc(n.content || 'No content')}</p>
          ${(n.attachments && n.attachments.length) ? `<div style="font-size:.72rem;color:var(--muted);margin-bottom:.3rem;"><i class="fas fa-paperclip me-1"></i>${n.attachments.length} file${n.attachments.length !== 1 ? 's' : ''}</div>` : ''}
          <div class="note-meta d-flex justify-content-between align-items-center">
            <span>${timeAgo(n.updatedAt)}</span>
            <div class="d-flex gap-1">
              <button class="btn btn-outline-info btn-sm py-0 px-2" title="View & Attachments" onclick="viewNote('${n._id}')">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn btn-outline-secondary btn-sm py-0 px-2" title="${n.isShared?'Unshare':'Share'}" onclick="toggleShare('${n._id}')">
                <i class="fas fa-${n.isShared?'share-alt':'share'}"></i>
              </button>
              <button class="btn btn-outline-primary btn-sm py-0 px-2" onclick="openEdit(${JSON.stringify(n).replace(/"/g,'&quot;')})">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-outline-danger btn-sm py-0 px-2" onclick="deleteNote('${n._id}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </div>`).join('');
  }

  function openAdd() {
    document.getElementById('noteId').value = '';
    document.getElementById('noteTitle').value = '';
    document.getElementById('noteSubject').value = '';
    document.getElementById('noteContent').value = '';
    document.getElementById('modalTitle').textContent = 'Add Note';
    document.getElementById('saveText').textContent = 'Save Note';
    document.getElementById('noteAddFileInput').value = '';
    document.getElementById('noteAddFilePreview').innerHTML = '';
    document.getElementById('noteAddFileSection').style.display = 'block';
  }

  function openEdit(n) {
    document.getElementById('noteId').value = n._id;
    document.getElementById('noteTitle').value = n.title;
    document.getElementById('noteSubject').value = n.subject || '';
    document.getElementById('noteContent').value = n.content || '';
    document.getElementById('modalTitle').textContent = 'Edit Note';
    document.getElementById('saveText').textContent = 'Update Note';
    document.getElementById('noteAddFileSection').style.display = 'none';
    new bootstrap.Modal(document.getElementById('noteModal')).show();
  }

  function updateNoteFilePreview() {
    const files = document.getElementById('noteAddFileInput').files;
    const el = document.getElementById('noteAddFilePreview');
    if (!files.length) { el.innerHTML = ''; return; }
    el.innerHTML = Array.from(files).map(f =>
      `<div style="font-size:.8rem;color:var(--muted);padding:.15rem 0;"><i class="fas fa-${fileIcon(f.type)} me-1" style="color:var(--info);"></i>${esc(f.name)} <span style="color:var(--muted);">(${fmtSize(f.size)})</span></div>`
    ).join('');
  }

  function viewNote(id) {
    const n = allNotes.find(x => x._id === id);
    if (!n) return;
    currentViewNoteId = n._id;
    document.getElementById('viewTitle').textContent = n.title;
    document.getElementById('viewMeta').innerHTML = `
      ${n.subject ? `<span class="subject-tag">${esc(n.subject)}</span> · ` : ''}
      Updated ${fmtDateTime(n.updatedAt)}
      ${n.isShared ? ' · <span class="shared-badge"><i class="fas fa-share-alt me-1"></i>Shared</span>' : ''}`;
    document.getElementById('viewContent').textContent = n.content || 'No content';
    renderNoteAttachments(n.attachments || []);
    new bootstrap.Modal(document.getElementById('viewModal')).show();
  }

  function openEditFromView() {
    const n = allNotes.find(x => x._id === currentViewNoteId);
    bootstrap.Modal.getInstance(document.getElementById('viewModal')).hide();
    if (n) setTimeout(() => openEdit(n), 300);
  }

  function renderNoteAttachments(attachments) {
    const el = document.getElementById('noteAttachmentsList');
    if (!attachments.length) {
      el.innerHTML = '<div style="color:var(--muted);font-size:.82rem;padding:.4rem 0;">No files attached yet.</div>';
      return;
    }
    el.innerHTML = attachments.map(a => `
      <div class="attachment-item">
        <i class="fas fa-${fileIcon(a.mimetype)} att-icon"></i>
        <a class="att-name" href="/api/files/${a.fileId}?token=${localStorage.getItem('token')}" target="_blank" title="${esc(a.originalName)}">${esc(a.originalName)}</a>
        <span class="att-size">${fmtSize(a.size)}</span>
        <div class="att-actions">
          <button class="btn btn-outline-danger btn-sm py-0 px-1" onclick="deleteNoteAttachment('${a.fileId}')">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>`).join('');
  }

  async function uploadNoteFile() {
    const input = document.getElementById('noteFileInput');
    if (!input.files.length || !currentViewNoteId) return;
    const formData = new FormData();
    formData.append('file', input.files[0]);
    const prog = document.getElementById('noteUploadProgress');
    prog.classList.remove('d-none');
    try {
      const attachment = await apiUpload('POST', `/notes/${currentViewNoteId}/attachments`, formData);
      const note = allNotes.find(n => n._id === currentViewNoteId);
      if (note) { note.attachments = note.attachments || []; note.attachments.push(attachment); }
      renderNoteAttachments(note ? note.attachments : [attachment]);
      renderNotes();
      toast('File uploaded!', 'success');
    } catch (err) { toast(err.message, 'error'); }
    finally { prog.classList.add('d-none'); input.value = ''; }
  }

  async function deleteNoteAttachment(fileId) {
    if (!confirm2('Remove this attachment?')) return;
    try {
      await api('DELETE', `/notes/${currentViewNoteId}/attachments/${fileId}`);
      const note = allNotes.find(n => n._id === currentViewNoteId);
      if (note) note.attachments = note.attachments.filter(a => a.fileId !== fileId);
      renderNoteAttachments(note ? note.attachments : []);
      renderNotes();
      toast('Attachment removed.', 'success');
    } catch (err) { toast(err.message, 'error'); }
  }

  async function saveNote() {
    const id      = document.getElementById('noteId').value;
    const title   = document.getElementById('noteTitle').value.trim();
    const subject = document.getElementById('noteSubject').value.trim();
    const content = document.getElementById('noteContent').value;
    if (!title) { toast('Title is required.', 'warning'); return; }

    const spin = document.getElementById('saveSpinner');
    spin.classList.remove('d-none');
    try {
      if (id) {
        await api('PUT', `/notes/${id}`, { title, subject, content });
        toast('Note updated!', 'success');
      } else {
        const newNote = await api('POST', '/notes', { title, subject, content });
        const files = document.getElementById('noteAddFileInput').files;
        for (const file of files) {
          const fd = new FormData();
          fd.append('file', file);
          await apiUpload('POST', `/notes/${newNote._id}/attachments`, fd);
        }
        toast(files.length ? `Note added with ${files.length} file${files.length>1?'s':''}!` : 'Note added!', 'success');
      }
      bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
      loadNotes();
    } catch (err) { toast(err.message, 'error'); }
    finally { spin.classList.add('d-none'); }
  }

  async function deleteNote(id) {
    if (!confirm2('Delete this note?')) return;
    try {
      await api('DELETE', `/notes/${id}`);
      toast('Note deleted.', 'success');
      loadNotes();
    } catch (err) { toast(err.message, 'error'); }
  }

  async function toggleShare(id) {
    try {
      await api('PATCH', `/notes/${id}/share`);
      const n = allNotes.find(x => x._id === id);
      toast(n && n.isShared ? 'Note unshared.' : 'Note shared!', 'success');
      loadNotes();
    } catch (err) { toast(err.message, 'error'); }
  }

  loadNotes();
</script>
</body>
</html>

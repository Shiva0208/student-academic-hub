<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard — Student Academic Hub</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
  <div class="container">
    <a class="navbar-brand" href="dashboard.html"><i class="fas fa-graduation-cap me-2"></i>AcademicHub</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" data-page="dashboard" href="dashboard.html"><i class="fas fa-th-large me-1"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" data-page="notes"    href="notes.html"><i class="fas fa-sticky-note me-1"></i>Notes</a></li>
        <li class="nav-item"><a class="nav-link" data-page="projects" href="projects.html"><i class="fas fa-project-diagram me-1"></i>Projects</a></li>
        <li class="nav-item"><a class="nav-link" data-page="deadlines" href="deadlines.html"><i class="fas fa-clock me-1"></i>Deadlines</a></li>
        <li class="nav-item"><a class="nav-link" data-page="groups"  href="groups.html"><i class="fas fa-users me-1"></i>Groups</a></li>
      </ul>
      <div class="d-flex align-items-center gap-3">
        <span class="text-light" id="studentName"></span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()"><i class="fas fa-sign-out-alt me-1"></i>Logout</button>
      </div>
    </div>
  </div>
</nav>

<div class="container py-4">

  <!-- Welcome Banner -->
  <div class="welcome-banner">
    <h4><i class="fas fa-sun me-2"></i>Welcome back, <span id="welcomeName">Student</span>!</h4>
    <p>Here's your academic overview for today.</p>
  </div>

  <!-- Stats Row -->
  <div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
      <div class="stat-card notes">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="stat-number" id="statNotes">—</div>
            <div class="stat-label">Total Notes</div>
          </div>
          <i class="fas fa-sticky-note stat-icon"></i>
        </div>
        <a href="notes.html" class="stretched-link"></a>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="stat-card projects">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="stat-number" id="statProjects">—</div>
            <div class="stat-label">Projects</div>
          </div>
          <i class="fas fa-project-diagram stat-icon"></i>
        </div>
        <a href="projects.html" class="stretched-link"></a>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="stat-card deadlines">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="stat-number" id="statDeadlines">—</div>
            <div class="stat-label">Upcoming</div>
          </div>
          <i class="fas fa-clock stat-icon"></i>
        </div>
        <a href="deadlines.html" class="stretched-link"></a>
      </div>
    </div>
    <div class="col-6 col-md-3">
      <div class="stat-card groups">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="stat-number" id="statGroups">—</div>
            <div class="stat-label">Groups</div>
          </div>
          <i class="fas fa-users stat-icon"></i>
        </div>
        <a href="groups.html" class="stretched-link"></a>
      </div>
    </div>
  </div>

  <div class="row g-4">

    <!-- Recent Notes -->
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-sticky-note me-2 text-info"></i>Recent Notes</span>
          <a href="notes.html" class="btn btn-outline-primary btn-sm">View All</a>
        </div>
        <div class="card-body p-2" id="recentNotes">
          <div class="empty-state"><i class="fas fa-spinner fa-spin"></i></div>
        </div>
      </div>
    </div>

    <!-- Upcoming Deadlines -->
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-clock me-2" style="color:var(--danger)"></i>Upcoming Deadlines</span>
          <a href="deadlines.html" class="btn btn-outline-primary btn-sm">View All</a>
        </div>
        <div class="card-body p-2" id="recentDeadlines">
          <div class="empty-state"><i class="fas fa-spinner fa-spin"></i></div>
        </div>
      </div>
    </div>

    <!-- Recent Projects -->
    <div class="col-md-4">
      <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-project-diagram me-2" style="color:var(--accent)"></i>Projects</span>
          <a href="projects.html" class="btn btn-outline-primary btn-sm">View All</a>
        </div>
        <div class="card-body p-2" id="recentProjects">
          <div class="empty-state"><i class="fas fa-spinner fa-spin"></i></div>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/utils.js"></script>
<script>
  if (!checkAuth()) throw new Error('Not logged in');
  initNav('dashboard');

  const student = getStudent();
  document.getElementById('welcomeName').textContent = student.name.split(' ')[0];

  async function loadDashboard() {
    try {
      const [notes, projects, deadlines, groups] = await Promise.all([
        api('GET', '/notes'),
        api('GET', '/projects'),
        api('GET', '/deadlines'),
        api('GET', '/groups')
      ]);

      // Stats
      document.getElementById('statNotes').textContent = notes.length;
      document.getElementById('statProjects').textContent = projects.length;
      const upcoming = deadlines.filter(d => d.status === 'upcoming');
      document.getElementById('statDeadlines').textContent = upcoming.length;
      document.getElementById('statGroups').textContent = groups.length;

      // Recent Notes
      const notesEl = document.getElementById('recentNotes');
      if (!notes.length) { notesEl.innerHTML = '<div class="empty-state"><i class="fas fa-sticky-note"></i><p>No notes yet</p></div>'; }
      else {
        notesEl.innerHTML = notes.slice(0,5).map(n => `
          <div class="p-2 mb-1" style="border-bottom:1px solid var(--card-border)">
            <div class="fw-600 text-truncate">${esc(n.title)}</div>
            <small style="color:var(--muted)">${n.subject ? esc(n.subject)+' · ' : ''}${timeAgo(n.updatedAt)}</small>
          </div>`).join('');
      }

      // Upcoming Deadlines
      const dlEl = document.getElementById('recentDeadlines');
      const soon = deadlines.filter(d => d.status === 'upcoming').slice(0,5);
      if (!soon.length) { dlEl.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle" style="color:var(--success)"></i><p>No upcoming deadlines</p></div>'; }
      else {
        dlEl.innerHTML = soon.map(d => {
          const days = daysUntil(d.dueDate);
          const cls = days < 0 ? 'overdue' : days <= 3 ? 'due-soon' : '';
          return `<div class="p-2 mb-1" style="border-bottom:1px solid var(--card-border)">
            <div class="fw-600 text-truncate">${esc(d.title)}</div>
            <small class="${cls}">${days < 0 ? 'Overdue' : days === 0 ? 'Due Today' : `${days}d left`} · ${priorityTag(d.priority)}</small>
          </div>`;
        }).join('');
      }

      // Recent Projects
      const projEl = document.getElementById('recentProjects');
      if (!projects.length) { projEl.innerHTML = '<div class="empty-state"><i class="fas fa-project-diagram"></i><p>No projects yet</p></div>'; }
      else {
        projEl.innerHTML = projects.slice(0,5).map(p => `
          <div class="p-2 mb-1" style="border-bottom:1px solid var(--card-border)">
            <div class="d-flex justify-content-between align-items-center">
              <div class="fw-600 text-truncate me-2">${esc(p.title)}</div>
              ${statusBadge(p.status)}
            </div>
            <small style="color:var(--muted)">${p.dueDate ? 'Due '+fmtDate(p.dueDate) : 'No due date'}</small>
          </div>`).join('');
      }

    } catch (err) {
      toast(err.message, 'error');
    }
  }

  loadDashboard();
</script>
</body>
</html>

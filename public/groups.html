<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Groups — Student Academic Hub</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
  <div class="container">
    <a class="navbar-brand" href="dashboard.html"><i class="fas fa-graduation-cap me-2"></i>AcademicHub</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" data-page="dashboard" href="dashboard.html"><i class="fas fa-th-large me-1"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" data-page="notes"     href="notes.html"><i class="fas fa-sticky-note me-1"></i>Notes</a></li>
        <li class="nav-item"><a class="nav-link" data-page="projects"  href="projects.html"><i class="fas fa-project-diagram me-1"></i>Projects</a></li>
        <li class="nav-item"><a class="nav-link" data-page="deadlines" href="deadlines.html"><i class="fas fa-clock me-1"></i>Deadlines</a></li>
        <li class="nav-item"><a class="nav-link" data-page="groups"    href="groups.html"><i class="fas fa-users me-1"></i>Groups</a></li>
      </ul>
      <div class="d-flex align-items-center gap-3">
        <span class="text-light" id="studentName"></span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()"><i class="fas fa-sign-out-alt me-1"></i>Logout</button>
      </div>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
    <h4 class="page-title mb-0"><i class="fas fa-users me-2"></i>Study Groups</h4>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#joinModal">
        <i class="fas fa-sign-in-alt me-1"></i>Join Group
      </button>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createModal" onclick="resetCreate()">
        <i class="fas fa-plus me-1"></i>Create Group
      </button>
    </div>
  </div>

  <!-- Groups Grid -->
  <div class="row g-3" id="groupsGrid">
    <div class="col-12"><div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></div></div>
  </div>
</div>

<!-- Group Detail Panel (shown when a group is selected) -->
<div id="groupDetailPanel" style="display:none;">
  <div class="container pb-4">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0" id="detailGroupName"></h5>
        <button class="btn btn-outline-secondary btn-sm" onclick="closeDetail()"><i class="fas fa-times me-1"></i>Close</button>
      </div>
      <div class="card-body">
        <div class="row g-4">
          <!-- Members -->
          <div class="col-md-4">
            <h6 class="text-accent mb-3"><i class="fas fa-user-friends me-1"></i>Members</h6>
            <div id="membersList"></div>
            <div class="mt-3 p-2" style="background:rgba(108,99,255,.06);border-radius:8px;">
              <div style="font-size:.8rem;color:var(--muted);">Invite Code</div>
              <div class="invite-code mt-1" id="detailInviteCode"></div>
              <button class="btn btn-outline-secondary btn-sm mt-2" onclick="copyCode()">
                <i class="fas fa-copy me-1"></i>Copy
              </button>
            </div>
          </div>

          <!-- Shared Resources -->
          <div class="col-md-8">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="text-accent mb-0"><i class="fas fa-share-alt me-1"></i>Shared Resources</h6>
              <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#shareModal" onclick="loadShareOptions()">
                <i class="fas fa-plus me-1"></i>Share
              </button>
            </div>
            <div id="resourcesList">
              <div class="empty-state" style="padding:1.5rem"><i class="fas fa-spinner fa-spin"></i></div>
            </div>
            <!-- Group Files -->
            <div class="mt-4 pt-3" style="border-top:1px solid var(--card-border)">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="text-accent mb-0"><i class="fas fa-paperclip me-1"></i>Group Files</h6>
                <label class="btn btn-outline-secondary btn-sm" style="cursor:pointer;">
                  <i class="fas fa-upload me-1"></i>Upload File
                  <input type="file" id="groupFileInput" style="display:none;" onchange="uploadGroupFile()" />
                </label>
              </div>
              <div id="groupFilesList">
                <div class="empty-state" style="padding:1rem"><i class="fas fa-spinner fa-spin"></i></div>
              </div>
              <div id="groupUploadProgress" class="upload-progress d-none" style="margin-top:.5rem;"></div>
            </div>

            <div class="mt-3 pt-3 d-flex gap-2" style="border-top:1px solid var(--card-border)">
              <button class="btn btn-outline-danger btn-sm" id="leaveGroupBtn" onclick="leaveGroup()">
                <i class="fas fa-sign-out-alt me-1"></i>Leave Group
              </button>
              <button class="btn btn-danger btn-sm d-none" id="deleteGroupBtn" onclick="deleteGroup()">
                <i class="fas fa-trash me-1"></i>Delete Group
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Create Group Modal -->
<div class="modal fade" id="createModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create Study Group</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label>Group Name *</label>
          <input type="text" id="createName" class="form-control mt-1" placeholder="e.g. Math Study Crew" />
        </div>
        <div class="mb-3">
          <label>Description</label>
          <textarea id="createDesc" class="form-control mt-1" rows="3" placeholder="What is this group for?"></textarea>
        </div>
        <div class="mb-3">
          <label>Attachments <span style="color:var(--muted);font-size:.82rem;">(optional)</span></label>
          <label class="btn btn-outline-secondary btn-sm mt-1 d-block" style="cursor:pointer;text-align:left;">
            <i class="fas fa-paperclip me-1"></i>Choose files
            <input type="file" id="groupCreateFileInput" multiple style="display:none;" onchange="updateGroupCreatePreview()" />
          </label>
          <div id="groupCreateFilePreview" style="margin-top:.4rem;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="createGroup()">
          <span id="createSpinner" class="spinner-border spinner-border-sm me-1 d-none"></span>
          Create Group
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Join Group Modal -->
<div class="modal fade" id="joinModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Join a Group</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label>Invite Code</label>
        <input type="text" id="joinCode" class="form-control mt-1" placeholder="Enter 6-character code" maxlength="6" style="letter-spacing:3px;font-family:monospace;font-size:1.1rem;text-transform:uppercase;" />
        <small style="color:var(--muted)">Ask a group admin for the invite code.</small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="joinGroup()">
          <span id="joinSpinner" class="spinner-border spinner-border-sm me-1 d-none"></span>
          Join Group
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Share Resource Modal -->
<div class="modal fade" id="shareModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Share to Group</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label>Resource Type</label>
          <select id="shareType" class="form-select mt-1" onchange="loadShareOptions()">
            <option value="note">Note</option>
            <option value="project">Project</option>
          </select>
        </div>
        <div class="mb-3">
          <label>Select Resource</label>
          <select id="shareResource" class="form-select mt-1">
            <option>Loading...</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="shareResource()">
          <span id="shareSpinner" class="spinner-border spinner-border-sm me-1 d-none"></span>
          Share
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/utils.js"></script>
<script>
  if (!checkAuth()) throw new Error('Not logged in');
  initNav('groups');

  let allGroups  = [];
  let activeGroup = null;
  const student  = getStudent();

  async function loadGroups() {
    try {
      allGroups = await api('GET', '/groups');
      renderGroups();
    } catch (err) { toast(err.message, 'error'); }
  }

  function renderGroups() {
    const grid = document.getElementById('groupsGrid');
    if (!allGroups.length) {
      grid.innerHTML = `<div class="col-12"><div class="empty-state"><i class="fas fa-users"></i><p>You're not in any groups yet.</p><p><button class="btn btn-primary btn-sm me-2" data-bs-toggle="modal" data-bs-target="#createModal" onclick="resetCreate()">Create Group</button><button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#joinModal">Join Group</button></p></div></div>`;
      return;
    }
    grid.innerHTML = allGroups.map(g => {
      const memberCount = g.members ? g.members.length : 0;
      const isAdmin = g.members && g.members.some(m => m.studentId && (m.studentId._id||m.studentId).toString() === student.id && m.role === 'admin');
      return `
      <div class="col-sm-6 col-md-4">
        <div class="group-card" onclick="openGroup('${g._id}')">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h6 class="fw-600 mb-0">${esc(g.name)}</h6>
            ${isAdmin ? '<span class="status-badge status-completed">Admin</span>' : '<span class="status-badge status-in_progress">Member</span>'}
          </div>
          ${g.description ? `<p class="mb-2" style="font-size:.84rem;color:var(--muted)">${esc(g.description)}</p>` : ''}
          <div class="d-flex justify-content-between align-items-center mt-2" style="font-size:.8rem;color:var(--muted)">
            <span><i class="fas fa-users me-1"></i>${memberCount} member${memberCount!==1?'s':''}</span>
            <span class="invite-code" style="font-size:.8rem;letter-spacing:2px;">${g.inviteCode}</span>
          </div>
        </div>
      </div>`;
    }).join('');
  }

  async function openGroup(id) {
    activeGroup = allGroups.find(g => g._id === id);
    if (!activeGroup) return;

    document.getElementById('groupDetailPanel').style.display = 'block';
    document.getElementById('groupDetailPanel').scrollIntoView({ behavior: 'smooth' });
    document.getElementById('detailGroupName').textContent = activeGroup.name;
    document.getElementById('detailInviteCode').textContent = activeGroup.inviteCode;

    // Members
    const membersEl = document.getElementById('membersList');
    try {
      const detailed = await api('GET', `/groups/${id}`);
      activeGroup = detailed;
      membersEl.innerHTML = (detailed.members||[]).map(m => {
        const name = m.studentId ? m.studentId.name : 'Unknown';
        return `<div class="d-flex align-items-center gap-2 mb-2">
          <div class="member-avatar">${avatar(name)}</div>
          <div>
            <div style="font-size:.88rem;font-weight:600">${esc(name)}</div>
            <div style="font-size:.75rem;color:var(--muted)">${m.role}</div>
          </div>
        </div>`;
      }).join('');

      // Show delete button only for admin, hide leave for admin
      const isAdmin = (detailed.members||[]).some(m =>
        m.studentId && (m.studentId._id||m.studentId).toString() === student.id && m.role === 'admin'
      );
      document.getElementById('deleteGroupBtn').classList.toggle('d-none', !isAdmin);
      document.getElementById('leaveGroupBtn').classList.toggle('d-none', isAdmin);
    } catch (err) { membersEl.innerHTML = `<p style="color:var(--danger)">${err.message}</p>`; }

    loadResources(id);
    loadGroupFiles(id);
  }

  async function loadResources(id) {
    const resEl = document.getElementById('resourcesList');
    resEl.innerHTML = '<div class="empty-state" style="padding:1rem"><i class="fas fa-spinner fa-spin"></i></div>';
    try {
      const resources = await api('GET', `/groups/${id}/resources`);
      if (!resources.length) {
        resEl.innerHTML = '<div class="empty-state" style="padding:1.5rem"><i class="fas fa-share-alt"></i><p>No resources shared yet</p></div>';
        return;
      }
      resEl.innerHTML = resources.map(r => {
        const title = r.resource ? r.resource.title : '(deleted)';
        return `<div class="resource-item">
          <div class="d-flex align-items-center gap-2">
            <span class="res-type ${r.resourceType}">${r.resourceType}</span>
            <span class="fw-600" style="font-size:.88rem">${esc(title)}</span>
          </div>
          <div style="font-size:.75rem;color:var(--muted);margin-top:.25rem">
            Shared by ${r.sharedBy ? esc(r.sharedBy.name) : 'Unknown'} · ${timeAgo(r.sharedAt)}
          </div>
        </div>`;
      }).join('');
    } catch (err) { resEl.innerHTML = `<p style="color:var(--danger);padding:1rem;">${err.message}</p>`; }
  }

  function closeDetail() {
    document.getElementById('groupDetailPanel').style.display = 'none';
    activeGroup = null;
  }

  function copyCode() {
    const code = document.getElementById('detailInviteCode').textContent;
    navigator.clipboard.writeText(code).then(() => toast('Invite code copied!', 'success'));
  }

  function resetCreate() {
    document.getElementById('createName').value = '';
    document.getElementById('createDesc').value = '';
    document.getElementById('groupCreateFileInput').value = '';
    document.getElementById('groupCreateFilePreview').innerHTML = '';
  }

  function updateGroupCreatePreview() {
    const files = document.getElementById('groupCreateFileInput').files;
    const el = document.getElementById('groupCreateFilePreview');
    if (!files.length) { el.innerHTML = ''; return; }
    el.innerHTML = Array.from(files).map(f =>
      `<div style="font-size:.8rem;color:var(--muted);padding:.15rem 0;"><i class="fas fa-${fileIcon(f.type)} me-1" style="color:var(--info);"></i>${esc(f.name)} <span style="color:var(--muted);">(${fmtSize(f.size)})</span></div>`
    ).join('');
  }

  async function createGroup() {
    const name = document.getElementById('createName').value.trim();
    if (!name) { toast('Group name is required.', 'warning'); return; }
    const spin = document.getElementById('createSpinner');
    spin.classList.remove('d-none');
    try {
      const newGroup = await api('POST', '/groups', { name, description: document.getElementById('createDesc').value });
      const files = document.getElementById('groupCreateFileInput').files;
      for (const file of files) {
        const fd = new FormData();
        fd.append('file', file);
        await apiUpload('POST', `/groups/${newGroup._id}/files`, fd);
      }
      bootstrap.Modal.getInstance(document.getElementById('createModal')).hide();
      toast(files.length ? `Group created with ${files.length} file${files.length>1?'s':''}!` : 'Group created!', 'success');
      loadGroups();
    } catch (err) { toast(err.message, 'error'); }
    finally { spin.classList.add('d-none'); }
  }

  async function joinGroup() {
    const code = document.getElementById('joinCode').value.trim().toUpperCase();
    if (!code) { toast('Enter an invite code.', 'warning'); return; }
    const spin = document.getElementById('joinSpinner');
    spin.classList.remove('d-none');
    try {
      await api('POST', '/groups/join', { inviteCode: code });
      bootstrap.Modal.getInstance(document.getElementById('joinModal')).hide();
      toast('Joined group!', 'success');
      loadGroups();
    } catch (err) { toast(err.message, 'error'); }
    finally { spin.classList.add('d-none'); }
  }

  async function loadShareOptions() {
    const type = document.getElementById('shareType').value;
    const sel  = document.getElementById('shareResource');
    sel.innerHTML = '<option>Loading...</option>';
    try {
      const items = await api('GET', `/${type}s`);
      if (!items.length) { sel.innerHTML = '<option>No ' + type + 's found</option>'; return; }
      sel.innerHTML = items.map(i => `<option value="${i._id}">${esc(i.title)}</option>`).join('');
    } catch (err) { sel.innerHTML = '<option>Error loading</option>'; }
  }

  async function shareResource() {
    if (!activeGroup) return;
    const resourceType = document.getElementById('shareType').value;
    const resourceId   = document.getElementById('shareResource').value;
    const spin = document.getElementById('shareSpinner');
    spin.classList.remove('d-none');
    try {
      await api('POST', `/groups/${activeGroup._id}/share`, { resourceType, resourceId });
      bootstrap.Modal.getInstance(document.getElementById('shareModal')).hide();
      toast('Shared successfully!', 'success');
      loadResources(activeGroup._id);
    } catch (err) { toast(err.message, 'error'); }
    finally { spin.classList.add('d-none'); }
  }

  async function leaveGroup() {
    if (!activeGroup) return;
    if (!confirm2(`Leave "${activeGroup.name}"?`)) return;
    try {
      await api('DELETE', `/groups/${activeGroup._id}/leave`);
      toast('You left the group.', 'success');
      closeDetail();
      loadGroups();
    } catch (err) { toast(err.message, 'error'); }
  }

  async function deleteGroup() {
    if (!activeGroup) return;
    if (!confirm2(`Permanently delete "${activeGroup.name}"? This will remove all members, shared resources, and uploaded files.`)) return;
    try {
      await api('DELETE', `/groups/${activeGroup._id}`);
      toast('Group deleted.', 'success');
      closeDetail();
      loadGroups();
    } catch (err) { toast(err.message, 'error'); }
  }

  async function loadGroupFiles(id) {
    const el = document.getElementById('groupFilesList');
    el.innerHTML = '<div class="empty-state" style="padding:1rem"><i class="fas fa-spinner fa-spin"></i></div>';
    try {
      const files = await api('GET', `/groups/${id}/files`);
      renderGroupFiles(files);
    } catch (err) {
      el.innerHTML = `<p style="color:var(--danger);padding:.5rem;">${err.message}</p>`;
    }
  }

  function renderGroupFiles(files) {
    const el = document.getElementById('groupFilesList');
    if (!files.length) {
      el.innerHTML = '<div class="empty-state" style="padding:1.5rem"><i class="fas fa-paperclip"></i><p>No files uploaded yet</p></div>';
      return;
    }
    el.innerHTML = files.map(f => `
      <div class="attachment-item" data-id="${f._id}">
        <i class="fas fa-${fileIcon(f.mimetype)} att-icon"></i>
        <a class="att-name" href="/api/files/${f.fileId}?token=${localStorage.getItem('token')}" target="_blank" title="${esc(f.originalName)}">${esc(f.originalName)}</a>
        <span class="att-size">${fmtSize(f.size)}</span>
        <div class="att-actions" style="flex-direction:column;align-items:flex-end;gap:0;">
          <span style="font-size:.7rem;color:var(--muted);">${f.uploadedBy ? esc(f.uploadedBy.name) : 'Unknown'}</span>
          <button class="btn btn-outline-danger btn-sm py-0 px-1 mt-1" onclick="deleteGroupFile('${f._id}')">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>`).join('');
  }

  async function uploadGroupFile() {
    const input = document.getElementById('groupFileInput');
    if (!input.files.length || !activeGroup) return;
    const formData = new FormData();
    formData.append('file', input.files[0]);
    const prog = document.getElementById('groupUploadProgress');
    prog.classList.remove('d-none');
    try {
      await apiUpload('POST', `/groups/${activeGroup._id}/files`, formData);
      toast('File uploaded!', 'success');
      loadGroupFiles(activeGroup._id);
    } catch (err) { toast(err.message, 'error'); }
    finally { prog.classList.add('d-none'); input.value = ''; }
  }

  async function deleteGroupFile(groupFileId) {
    if (!confirm2('Delete this file from the group?')) return;
    try {
      await api('DELETE', `/groups/${activeGroup._id}/files/${groupFileId}`);
      toast('File deleted.', 'success');
      loadGroupFiles(activeGroup._id);
    } catch (err) { toast(err.message, 'error'); }
  }

  loadGroups();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Projects — Student Academic Hub</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
  <div class="container">
    <a class="navbar-brand" href="dashboard.html"><i class="fas fa-graduation-cap me-2"></i>AcademicHub</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" data-page="dashboard" href="dashboard.html"><i class="fas fa-th-large me-1"></i>Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" data-page="notes"     href="notes.html"><i class="fas fa-sticky-note me-1"></i>Notes</a></li>
        <li class="nav-item"><a class="nav-link" data-page="projects"  href="projects.html"><i class="fas fa-project-diagram me-1"></i>Projects</a></li>
        <li class="nav-item"><a class="nav-link" data-page="deadlines" href="deadlines.html"><i class="fas fa-clock me-1"></i>Deadlines</a></li>
        <li class="nav-item"><a class="nav-link" data-page="groups"    href="groups.html"><i class="fas fa-users me-1"></i>Groups</a></li>
      </ul>
      <div class="d-flex align-items-center gap-3">
        <span class="text-light" id="studentName"></span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()"><i class="fas fa-sign-out-alt me-1"></i>Logout</button>
      </div>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
    <h4 class="page-title mb-0"><i class="fas fa-project-diagram me-2"></i>My Projects</h4>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#projModal" onclick="openAdd()">
      <i class="fas fa-plus me-1"></i>Add Project
    </button>
  </div>

  <!-- Filter tabs -->
  <div class="d-flex flex-wrap gap-2 mb-4">
    <input type="text" id="searchInput" class="search-input" placeholder="Search projects..." style="max-width:260px;" oninput="renderProjects()" />
    <div class="filter-tabs d-flex gap-1 flex-wrap">
      <button class="btn btn-outline-secondary btn-sm active" id="filterAll"         onclick="setFilter('all')">All</button>
      <button class="btn btn-outline-secondary btn-sm"        id="filterPending"     onclick="setFilter('pending')">Pending</button>
      <button class="btn btn-outline-secondary btn-sm"        id="filterIn_progress" onclick="setFilter('in_progress')">In Progress</button>
      <button class="btn btn-outline-secondary btn-sm"        id="filterCompleted"   onclick="setFilter('completed')">Completed</button>
    </div>
  </div>

  <div class="row g-3" id="projectsGrid">
    <div class="col-12"><div class="empty-state"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></div></div>
  </div>
</div>

<!-- Add/Edit Modal -->
<div class="modal fade" id="projModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Add Project</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="projId" />
        <div class="mb-3">
          <label>Title *</label>
          <input type="text" id="projTitle" class="form-control mt-1" placeholder="Project title" />
        </div>
        <div class="mb-3">
          <label>Description</label>
          <textarea id="projDesc" class="form-control mt-1" rows="4" placeholder="Project description..."></textarea>
        </div>
        <div class="row g-3">
          <div class="col-sm-6">
            <label>Status</label>
            <select id="projStatus" class="form-select mt-1">
              <option value="pending">Pending</option>
              <option value="in_progress">In Progress</option>
              <option value="completed">Completed</option>
            </select>
          </div>
          <div class="col-sm-6">
            <label>Due Date</label>
            <input type="date" id="projDue" class="form-control mt-1" />
          </div>
        </div>
        <div class="mt-3" id="projAddFileSection">
          <label>Attachments <span style="color:var(--muted);font-size:.82rem;">(optional)</span></label>
          <label class="btn btn-outline-secondary btn-sm mt-1 d-block" style="cursor:pointer;text-align:left;">
            <i class="fas fa-paperclip me-1"></i>Choose files
            <input type="file" id="projAddFileInput" multiple style="display:none;" onchange="updateProjFilePreview()" />
          </label>
          <div id="projAddFilePreview" style="margin-top:.4rem;"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveProject()">
          <span id="saveSpinner" class="spinner-border spinner-border-sm me-1 d-none"></span>
          <span id="saveText">Save Project</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Project View Modal -->
<div class="modal fade" id="projViewModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="pvTitle"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="pvMeta" class="mb-3" style="color:var(--muted);font-size:.85rem;"></div>
        <div id="pvDesc" style="white-space:pre-wrap;line-height:1.7;margin-bottom:1rem;"></div>

        <!-- Attachments -->
        <div class="attachment-list">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <small style="color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.05em;">
              <i class="fas fa-paperclip me-1"></i>Attachments
            </small>
            <label class="btn btn-outline-secondary btn-sm py-0 px-2" style="cursor:pointer;">
              <i class="fas fa-upload me-1"></i>Upload
              <input type="file" id="projFileInput" style="display:none;" onchange="uploadProjFile()" />
            </label>
          </div>
          <div id="projAttachmentsList"></div>
          <div id="projUploadProgress" class="upload-progress d-none"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="openEditFromView()">
          <i class="fas fa-edit me-1"></i>Edit Project
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/utils.js"></script>
<script>
  if (!checkAuth()) throw new Error('Not logged in');
  initNav('projects');

  let allProjects       = [];
  let curFilter         = 'all';
  let currentViewProjId = null;

  async function loadProjects() {
    try {
      allProjects = await api('GET', '/projects');
      renderProjects();
    } catch (err) { toast(err.message, 'error'); }
  }

  function setFilter(f) {
    curFilter = f;
    document.querySelectorAll('.filter-tabs .btn').forEach(b => b.classList.remove('active'));
    const key = 'filter' + f.charAt(0).toUpperCase() + f.slice(1);
    document.getElementById(key).classList.add('active');
    renderProjects();
  }

  function renderProjects() {
    const q = document.getElementById('searchInput').value.toLowerCase();
    const projs = allProjects.filter(p => {
      const matchQ = p.title.toLowerCase().includes(q) || (p.description||'').toLowerCase().includes(q);
      const matchF = curFilter === 'all' || p.status === curFilter;
      return matchQ && matchF;
    });

    const grid = document.getElementById('projectsGrid');
    if (!projs.length) {
      grid.innerHTML = `<div class="col-12"><div class="empty-state"><i class="fas fa-project-diagram"></i><p>No projects found</p><button class="btn btn-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#projModal" onclick="openAdd()">Add your first project</button></div></div>`;
      return;
    }
    grid.innerHTML = projs.map(p => `
      <div class="col-sm-6 col-md-4">
        <div class="project-card">
          <div class="d-flex justify-content-between align-items-start mb-2">
            ${statusBadge(p.status)}
            ${p.isShared ? '<span class="shared-badge"><i class="fas fa-share-alt me-1"></i>Shared</span>' : ''}
          </div>
          <h6 class="fw-600 mb-1" style="cursor:pointer" onclick="viewProject('${p._id}')">${esc(p.title)}</h6>
          <p class="mb-2" style="font-size:.85rem;color:var(--muted);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;">
            ${esc(p.description || 'No description')}
          </p>
          <div style="font-size:.78rem;color:var(--muted);" class="mb-2">
            ${p.dueDate ? '<i class="fas fa-calendar-alt me-1"></i>Due ' + fmtDate(p.dueDate) : '<i class="fas fa-calendar-times me-1"></i>No due date'}
          </div>
          ${(p.attachments && p.attachments.length) ? `<div style="font-size:.72rem;color:var(--muted);margin-bottom:.3rem;"><i class="fas fa-paperclip me-1"></i>${p.attachments.length} file${p.attachments.length !== 1 ? 's' : ''}</div>` : ''}
          <div class="d-flex gap-1 justify-content-end">
            <button class="btn btn-outline-info btn-sm py-0 px-2" title="View & Attachments" onclick="viewProject('${p._id}')">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-outline-secondary btn-sm py-0 px-2" title="${p.isShared?'Unshare':'Share'}" onclick="toggleShare('${p._id}')">
              <i class="fas fa-share-alt"></i>
            </button>
            <button class="btn btn-outline-primary btn-sm py-0 px-2" onclick="openEdit(${JSON.stringify(p).replace(/"/g,'&quot;')})">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-outline-danger btn-sm py-0 px-2" onclick="deleteProject('${p._id}')">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      </div>`).join('');
  }

  function openAdd() {
    document.getElementById('projId').value = '';
    document.getElementById('projTitle').value = '';
    document.getElementById('projDesc').value = '';
    document.getElementById('projStatus').value = 'pending';
    document.getElementById('projDue').value = '';
    document.getElementById('modalTitle').textContent = 'Add Project';
    document.getElementById('saveText').textContent = 'Save Project';
    document.getElementById('projAddFileInput').value = '';
    document.getElementById('projAddFilePreview').innerHTML = '';
    document.getElementById('projAddFileSection').style.display = 'block';
  }

  function openEdit(p) {
    document.getElementById('projId').value = p._id;
    document.getElementById('projTitle').value = p.title;
    document.getElementById('projDesc').value = p.description || '';
    document.getElementById('projStatus').value = p.status;
    document.getElementById('projDue').value = p.dueDate ? p.dueDate.slice(0,10) : '';
    document.getElementById('modalTitle').textContent = 'Edit Project';
    document.getElementById('saveText').textContent = 'Update Project';
    document.getElementById('projAddFileSection').style.display = 'none';
    new bootstrap.Modal(document.getElementById('projModal')).show();
  }

  function updateProjFilePreview() {
    const files = document.getElementById('projAddFileInput').files;
    const el = document.getElementById('projAddFilePreview');
    if (!files.length) { el.innerHTML = ''; return; }
    el.innerHTML = Array.from(files).map(f =>
      `<div style="font-size:.8rem;color:var(--muted);padding:.15rem 0;"><i class="fas fa-${fileIcon(f.type)} me-1" style="color:var(--info);"></i>${esc(f.name)} <span style="color:var(--muted);">(${fmtSize(f.size)})</span></div>`
    ).join('');
  }

  async function saveProject() {
    const id    = document.getElementById('projId').value;
    const title = document.getElementById('projTitle').value.trim();
    if (!title) { toast('Title is required.', 'warning'); return; }

    const body = {
      title,
      description: document.getElementById('projDesc').value,
      status:  document.getElementById('projStatus').value,
      dueDate: document.getElementById('projDue').value || null
    };

    const spin = document.getElementById('saveSpinner');
    spin.classList.remove('d-none');
    try {
      if (id) {
        await api('PUT', `/projects/${id}`, body);
        toast('Project updated!', 'success');
      } else {
        const newProj = await api('POST', '/projects', body);
        const files = document.getElementById('projAddFileInput').files;
        for (const file of files) {
          const fd = new FormData();
          fd.append('file', file);
          await apiUpload('POST', `/projects/${newProj._id}/attachments`, fd);
        }
        toast(files.length ? `Project added with ${files.length} file${files.length>1?'s':''}!` : 'Project added!', 'success');
      }
      bootstrap.Modal.getInstance(document.getElementById('projModal')).hide();
      loadProjects();
    } catch (err) { toast(err.message, 'error'); }
    finally { spin.classList.add('d-none'); }
  }

  async function deleteProject(id) {
    if (!confirm2('Delete this project?')) return;
    try {
      await api('DELETE', `/projects/${id}`);
      toast('Project deleted.', 'success');
      loadProjects();
    } catch (err) { toast(err.message, 'error'); }
  }

  async function toggleShare(id) {
    try {
      await api('PATCH', `/projects/${id}/share`);
      toast('Share status updated.', 'success');
      loadProjects();
    } catch (err) { toast(err.message, 'error'); }
  }

  function viewProject(id) {
    const p = allProjects.find(x => x._id === id);
    if (!p) return;
    currentViewProjId = p._id;
    document.getElementById('pvTitle').textContent = p.title;
    document.getElementById('pvMeta').innerHTML = `
      ${statusBadge(p.status)}
      ${p.dueDate ? ` · <i class="fas fa-calendar-alt me-1"></i>Due ${fmtDate(p.dueDate)}` : ''}
      ${p.isShared ? ' · <span class="shared-badge"><i class="fas fa-share-alt me-1"></i>Shared</span>' : ''}`;
    document.getElementById('pvDesc').textContent = p.description || 'No description';
    renderProjAttachments(p.attachments || []);
    new bootstrap.Modal(document.getElementById('projViewModal')).show();
  }

  function openEditFromView() {
    const p = allProjects.find(x => x._id === currentViewProjId);
    bootstrap.Modal.getInstance(document.getElementById('projViewModal')).hide();
    if (p) setTimeout(() => openEdit(p), 300);
  }

  function renderProjAttachments(attachments) {
    const el = document.getElementById('projAttachmentsList');
    if (!attachments.length) {
      el.innerHTML = '<div style="color:var(--muted);font-size:.82rem;padding:.4rem 0;">No files attached yet.</div>';
      return;
    }
    el.innerHTML = attachments.map(a => `
      <div class="attachment-item">
        <i class="fas fa-${fileIcon(a.mimetype)} att-icon"></i>
        <a class="att-name" href="/api/files/${a.fileId}?token=${localStorage.getItem('token')}" target="_blank" title="${esc(a.originalName)}">${esc(a.originalName)}</a>
        <span class="att-size">${fmtSize(a.size)}</span>
        <div class="att-actions">
          <button class="btn btn-outline-danger btn-sm py-0 px-1" onclick="deleteProjAttachment('${a.fileId}')">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>`).join('');
  }

  async function uploadProjFile() {
    const input = document.getElementById('projFileInput');
    if (!input.files.length || !currentViewProjId) return;
    const formData = new FormData();
    formData.append('file', input.files[0]);
    const prog = document.getElementById('projUploadProgress');
    prog.classList.remove('d-none');
    try {
      const attachment = await apiUpload('POST', `/projects/${currentViewProjId}/attachments`, formData);
      const proj = allProjects.find(p => p._id === currentViewProjId);
      if (proj) { proj.attachments = proj.attachments || []; proj.attachments.push(attachment); }
      renderProjAttachments(proj ? proj.attachments : [attachment]);
      renderProjects();
      toast('File uploaded!', 'success');
    } catch (err) { toast(err.message, 'error'); }
    finally { prog.classList.add('d-none'); input.value = ''; }
  }

  async function deleteProjAttachment(fileId) {
    if (!confirm2('Remove this attachment?')) return;
    try {
      await api('DELETE', `/projects/${currentViewProjId}/attachments/${fileId}`);
      const proj = allProjects.find(p => p._id === currentViewProjId);
      if (proj) proj.attachments = proj.attachments.filter(a => a.fileId !== fileId);
      renderProjAttachments(proj ? proj.attachments : []);
      renderProjects();
      toast('Attachment removed.', 'success');
    } catch (err) { toast(err.message, 'error'); }
  }

  loadProjects();
</script>
</body>
</html>
